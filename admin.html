<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamo Surface Studio - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e67e22;
            --secondary-dark: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --accent: #3498db;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            transition: background 0.5s, color 0.5s;
        }
        .dark-mode body {
            background: var(--dark);
            color: var(--light);
        }
        .navbar {
            background: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .navbar .nav-link, .navbar .navbar-brand {
            color: var(--light) !important;
            transition: color 0.3s;
        }
        .navbar .nav-link:hover, .navbar .navbar-brand:hover {
            color: var(--secondary) !important;
        }
        .navbar .navbar-brand {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }
        .container {
            padding-top: 20px;
        }
        .card {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .dark-mode .card {
            background: #34495e;
            color: var(--light);
        }
        .card-header {
            background-color: var(--primary);
            color: var(--light);
            border-bottom: 1px solid var(--secondary);
            font-weight: 600;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .dark-mode .card-header {
            background-color: #2c3e50;
        }
        .btn-primary {
            background-color: var(--secondary);
            border-color: var(--secondary);
            color: var(--light);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--secondary-dark);
            border-color: var(--secondary-dark);
        }
        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
            transition: all 0.3s;
        }
        .btn-danger:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
            border-color: #2ecc71;
            transition: all 0.3s;
        }
        .btn-success:hover {
            background-color: #27ae60;
            border-color: #27ae60;
        }
        .form-control {
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .dark-mode .form-control {
            background: #2c3e50;
            color: var(--light);
            border-color: #555;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
            border-color: var(--accent);
        }
        .logo-text {
            color: var(--secondary);
            font-weight: bold;
        }
        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loader {
            border: 4px solid var(--light);
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .faqs-list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .faqs-list-group-item .faq-actions {
            display: flex;
            gap: 10px;
        }
        .dark-mode .list-group-item {
            background-color: #34495e;
            color: var(--light);
            border-color: #555;
        }
        .dark-mode .list-group-item:hover {
            background-color: #446280;
        }
        #login-section {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
        }
        .modal-content {
            background-color: var(--light);
            color: var(--dark);
        }
        .dark-mode .modal-content {
            background-color: #2c3e50;
            color: var(--light);
        }
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        .toast {
            background-color: #2ecc71;
            color: white;
        }
        .toast .btn-close {
            filter: invert(1);
        }
        .dark-mode .toast {
            background-color: #27ae60;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Metamo Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#" onclick="showPage('dashboard-section')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('faqs-section')">Manage FAQs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('admin-logs-section')">Admin Logs</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                        <label class="form-check-label text-light" for="darkModeSwitch">Dark Mode</label>
                    </div>
                    <button id="logout-button" class="btn btn-danger d-none">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <div id="login-section" class="page active">
            <div class="card login-card animate__animated animate__fadeIn">
                <div class="card-header text-center">
                    Admin Login
                </div>
                <div class="card-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                    <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" class="page animate__animated animate__fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class='bx bxs-dashboard me-2'></i>Dashboard
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Welcome to the Admin Panel!</h5>
                            <p class="card-text">Use the navigation bar to manage different sections of the website.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="faqs-section" class="page animate__animated animate__fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class='bx bx-question-mark me-2'></i>Manage FAQs</span>
                            <button id="add-faq-btn" class="btn btn-success btn-sm"><i class='bx bx-plus-circle me-1'></i>Add New FAQ</button>
                        </div>
                        <div class="card-body">
                            <div class="list-group" id="faqs-list">
                                <div class="text-center p-4">
                                    <div class="spinner-border text-secondary loader" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading FAQs...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-logs-section" class="page animate__animated animate__fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class='bx bx-history me-2'></i>Admin Login Logs</span>
                            <button id="copy-logs-btn" class="btn btn-primary btn-sm"><i class='bx bx-copy me-1'></i>Copy Logs</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>IP Address</th>
                                            <th>Device Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logs-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center p-4">
                                                <div class="spinner-border text-secondary loader" role="status">
                                                    <span class="visually-hidden">Loading logs...</span>
                                                </div>
                                                <p class="mt-2">Loading logs...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> <div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="faq-form">
                    <div class="modal-header">
                        <h5 class="modal-title" id="faqModalTitle">Add New FAQ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="faq-id">
                        <div class="mb-3">
                            <label for="faq-question" class="form-label">Question</label>
                            <input type="text" class="form-control" id="faq-question" required>
                        </div>
                        <div class="mb-3">
                            <label for="faq-answer" class="form-label">Answer</label>
                            <textarea class="form-control" id="faq-answer" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Login Successful!
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Your Firebase config object
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const faqsRef = database.ref('faqs');
        const adminLogsRef = database.ref('adminLogs');

        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginSection = document.getElementById('login-section');
        const mainContent = document.querySelector('.container');
        const loginError = document.getElementById('login-error');
        const liveToast = document.getElementById('liveToast');
        const faqModal = new bootstrap.Modal(document.getElementById('faqModal'));
        const faqForm = document.getElementById('faq-form');
        const faqsList = document.getElementById('faqs-list');

        let autoLogoutTimer;

        // Function to show a specific page and hide others
        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
            if (pageId === 'admin-logs-section') {
                loadAdminLogs();
            }
        };

        // Function to get user IP and device details
        const getIpAndDevice = async () => {
            let ip = 'N/A';
            let device = 'N/A';
            
            try {
                // Get IP address from a public API
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                ip = data.ip;
            } catch (error) {
                console.error("Error fetching IP address:", error);
            }
            
            // Get device details from the user agent string
            if (navigator.userAgent) {
                device = navigator.userAgent;
            }
            
            return { ip, device };
        };

        // Function to log admin login event to Firebase
        const logAdminLogin = async (email) => {
            const { ip, device } = await getIpAndDevice();
            const logEntry = {
                user: email,
                ip_address: ip,
                device_details: device,
                timestamp: new Date().toISOString()
            };
            adminLogsRef.push(logEntry);
        };

        // Function to start the 1-hour auto-logout timer
        const startAutoLogoutTimer = () => {
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
            }
            autoLogoutTimer = setTimeout(() => {
                auth.signOut();
                alert('You have been automatically logged out after 1 hour of inactivity.');
            }, 3600000); // 1 hour in milliseconds
        };

        // Function to load and display admin logs
        const loadAdminLogs = () => {
            const logsTableBody = document.getElementById('logs-table-body');
            logsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4"><div class="spinner-border text-secondary loader" role="status"><span class="visually-hidden">Loading logs...</span></div><p class="mt-2">Loading logs...</p></td></tr>`;
            
            adminLogsRef.on('value', (snapshot) => {
                const logs = snapshot.val();
                let tableHtml = '';
                if (logs) {
                    const logKeys = Object.keys(logs).reverse();
                    logKeys.forEach(key => {
                        const log = logs[key];
                        const date = new Date(log.timestamp).toLocaleString();
                        const ip = log.ip_address || 'N/A';
                        const device = log.device_details || 'N/A';
                        tableHtml += `
                            <tr>
                                <td>${date}</td>
                                <td>${log.user}</td>
                                <td>${ip}</td>
                                <td>${device}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHtml = `<tr><td colspan="4" class="text-center">No logs found.</td></tr>`;
                }
                logsTableBody.innerHTML = tableHtml;
            }, (error) => {
                console.error("Error fetching admin logs:", error);
                logsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error loading logs. Please check your Firebase connection.</td></tr>`;
            });
        };

        // Function to copy logs to clipboard
        const copyAdminLogs = () => {
            const logsTableBody = document.getElementById('logs-table-body');
            let logText = "Timestamp\tUser\tIP Address\tDevice Details\n";
            logsTableBody.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const timestamp = cells[0].textContent;
                    const user = cells[1].textContent;
                    const ip = cells[2].textContent;
                    const device = cells[3].textContent;
                    logText += `${timestamp}\t${user}\t${ip}\t${device}\n`;
                }
            });
            navigator.clipboard.writeText(logText).then(() => {
                alert('Admin logs copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy logs:', err);
                alert('Failed to copy logs. Please try again.');
            });
        };

        document.getElementById('copy-logs-btn').addEventListener('click', copyAdminLogs);

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                loginSection.classList.remove('active');
                mainContent.style.display = 'block';
                document.querySelector('.navbar').classList.remove('d-none');
                logoutButton.classList.remove('d-none');
                showPage('dashboard-section');
                startAutoLogoutTimer();
                
            } else {
                // User is signed out
                loginSection.classList.add('active');
                mainContent.style.display = 'none';
                document.querySelector('.navbar').classList.add('d-none');
                logoutButton.classList.add('d-none');
                if (autoLogoutTimer) {
                    clearTimeout(autoLogoutTimer);
                }
            }
        });

        // Handle login form submission
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('d-none');

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const toast = new bootstrap.Toast(liveToast);
                    toast.show();
                    logAdminLogin(email);
                    loginForm.reset();
                })
                .catch((error) => {
                    // Handle Errors here.
                    let errorMessage = error.message;
                    loginError.textContent = errorMessage;
                    loginError.classList.remove('d-none');
                });
        });

        // Handle logout
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // Dark mode toggle
        const darkModeSwitch = document.getElementById('darkModeSwitch');
        darkModeSwitch.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        });

        // FAQs logic
        document.addEventListener('DOMContentLoaded', () => {
            faqsRef.on('value', renderFaqs, (error) => {
                console.error("Error fetching FAQs:", error);
                faqsList.innerHTML = '<p class="text-center text-danger">Error loading FAQs. Please try again later.</p>';
            });

            const renderFaqs = (snapshot) => {
                const faqs = snapshot.val();
                let listHtml = '';
                if (faqs) {
                    Object.keys(faqs).reverse().forEach(key => {
                        const faq = faqs[key];
                        listHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${faq.question}</h6>
                                    <small class="text-muted">Last updated: ${new Date(faq.timestamp).toLocaleString()}</small>
                                </div>
                                <div class="faq-actions">
                                    <button class="btn btn-warning btn-sm edit-faq-btn" data-id="${key}"><i class='bx bx-edit'></i></button>
                                    <button class="btn btn-danger btn-sm delete-faq-btn" data-id="${key}"><i class='bx bx-trash'></i></button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    listHtml = '<p class="text-center p-3">No FAQs found. Add one to get started.</p>';
                }
                faqsList.innerHTML = listHtml;
            };

            faqsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-faq-btn')) {
                    editFaq(e);
                } else if (e.target.classList.contains('delete-faq-btn')) {
                    deleteFaq(e);
                }
            });

            document.getElementById('add-faq-btn').addEventListener('click', () => {
                document.getElementById('faqModalTitle').textContent = 'Add New FAQ';
                faqForm.reset();
                document.getElementById('faq-id').value = '';
                faqModal.show();
            });

            faqForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('faq-id').value;
                const question = document.getElementById('faq-question').value;
                const answer = document.getElementById('faq-answer').value;
                const data = { question, answer, timestamp: new Date().toISOString() };
                
                if (id) {
                    faqsRef.child(id).update(data);
                } else {
                    faqsRef.push(data);
                }
                faqModal.hide();
                faqForm.reset();
            });

            const editFaq = (e) => {
                const faqId = e.target.getAttribute('data-id');
                faqsRef.child(faqId).once('value', (snapshot) => {
                    const faq = snapshot.val();
                    document.getElementById('faq-id').value = faqId;
                    document.getElementById('faq-question').value = faq.question;
                    document.getElementById('faq-answer').value = faq.answer;
                    document.getElementById('faqModalTitle').textContent = 'Edit FAQ';
                    faqModal.show();
                });
            };

            const deleteFaq = (e) => {
                const faqId = e.target.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this FAQ?')) {
                    faqsRef.child(faqId).remove();
                }
            };
        });
    </script>
</body>
</html>
